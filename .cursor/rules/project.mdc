---
description: KatalogBul proje kurallarÄ± - tÃ¼m sohbetlerde aktif
globs: 
alwaysApply: true
---

# KatalogBul / MakineParÃ§a

## Proje Ã–zeti
Ä°ÅŸ makineleri (Komatsu, CAT, Volvo, Hitachi, JCB, Hyundai, Doosan) iÃ§in PDF parÃ§a kataloÄŸu arama ve analiz platformu. TÃ¼rkÃ§e B2B SaaS.

## Tech Stack
- **Backend**: FastAPI + Python 3.11
- **Database**: SQLite (data/pepc.db)
- **AI**: Claude Vision API (claude-sonnet-4)
- **Auth**: JWT + bcrypt + Fernet ÅŸifreleme
- **PDF**: PyMuPDF (fitz)
- **Payment**: PayTR iFrame
- **Frontend**: HTML5 + Tailwind CSS + Vanilla JS
- **Search APIs**: Serper (Google), Brave, Yandex, Firecrawl

## Kritik Dosyalar
| Dosya | AÃ§Ä±klama |
|-------|----------|
| api/main.py | TÃ¼m FastAPI endpoint'leri (~2700 satÄ±r) |
| src/database.py | SQLite ÅŸema, 25+ tablo |
| src/multi_search.py | 6 motor koordinasyonu |
| src/source_discovery.py | ğŸ†• Firecrawl /map + HTTP HEAD kaynak keÅŸfi |
| src/search/query_builder.py | OR operatÃ¶rlÃ¼ sorgu oluÅŸturucu |
| src/search/aggregator.py | Ã‡oklu motor birleÅŸtirici |
| src/catalog_service.py | Claude Vision entegrasyonu |
| src/auth.py | JWT authentication |
| src/credit_manager.py | Kredi sistemi |
| src/payment.py | PayTR entegrasyonu |
| src/source_scanner.py | Kaynak tarama sistemi (Admin) |
| src/firecrawl_google_scraper.py | Premium site aramasÄ± |

## Arama ModÃ¼l YapÄ±sÄ±
```
src/
â”œâ”€â”€ search/
â”‚   â”œâ”€â”€ query_builder.py    # OR operatÃ¶rlÃ¼ sorgu oluÅŸturma
â”‚   â”œâ”€â”€ aggregator.py       # Multi-engine birleÅŸtirici
â”‚   â”œâ”€â”€ google.py           # Serper client (yeni)
â”‚   â”œâ”€â”€ brave.py            # Brave client (yeni)
â”‚   â””â”€â”€ yandex.py           # Yandex client (yeni)
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ brands.py           # Marka listesi ve alias'lar
â”‚   â”œâ”€â”€ categories.py       # Kategori terimleri
â”‚   â””â”€â”€ domains.py          # Premium/excluded domain'ler
â”œâ”€â”€ pdf/
â”‚   â””â”€â”€ head_checker.py     # Paralel HTTP HEAD (50 concurrent)
â”œâ”€â”€ source_discovery.py     # ğŸ†• Firecrawl /map entegrasyonu
â”œâ”€â”€ brave_client.py         # Eski brave client (kullanÄ±mda)
â”œâ”€â”€ serper_client.py        # Eski serper client (kullanÄ±mda)
â”œâ”€â”€ yandex_client.py        # Yandex client
â””â”€â”€ multi_search.py         # Ana koordinatÃ¶r
```

## Arama MotorlarÄ±
| Motor | API | Dosya |
|-------|-----|-------|
| Google | Serper.dev | serper_client.py |
| Brave | api.search.brave.com | brave_client.py |
| Yandex | searchapi.api.cloud.yandex.net | yandex_client.py |
| SearchApi (Bing) | searchapi.io | searchapi_client.py |
| Firecrawl | api.firecrawl.dev | firecrawl_google_scraper.py, source_discovery.py |

## ğŸ†• Kaynak KeÅŸif Sistemi
```
Arama â†’ SonuÃ§lar â†’ Benzersiz Domain Ã‡Ä±kar â†’ Kaynaklar Tab
                                              â†“
                                    [Tara] butonu tÄ±klanÄ±r
                                              â†“
                                    Firecrawl /map (1 kredi)
                                              â†“
                                    HTTP HEAD paralel (Ã¼cretsiz)
                                              â†“
                                    Kaynak SonuÃ§larÄ± Tab
```

### Endpoint'ler
- `POST /api/sources/extract` - SonuÃ§lardan domain Ã§Ä±kar
- `GET /api/sources/{domain}/scan` - SSE ile kaynak tara
- `POST /api/sources/scan` - Senkron tarama
- `POST /api/sources/filter-by-size` - Boyut filtresi

## âš ï¸ Ã–NEMLÄ° - Arama HatalarÄ±ndan KaÃ§Ä±n
1. **Ã‡ift filetype ekleme**: Query builder zaten `filetype:pdf` ekliyor
2. **Yandex iÃ§in**: `filetype:pdf` â†’ `mime:pdf` dÃ¶nÃ¼ÅŸÃ¼mÃ¼ gerekli
3. **PDF kontrolÃ¼**: URL, title ve description'da `pdf` ara (Ã§ok kÄ±sÄ±tlÄ± olma)
4. **Pagination**: Brave 200, diÄŸerleri 100 sonuÃ§ limiti

## Kod KurallarÄ±
- Type hints ZORUNLU
- Async/await I/O iÅŸlemlerinde
- TÃ¼rkÃ§e yorumlar, Ä°ngilizce kod
- Pydantic model validasyonu
- HTTPException ile hata yÃ¶netimi

## GÃ¼venlik
- API key'ler Fernet ile ÅŸifreli (settings tablosu)
- Åifreler bcrypt hash
- JWT 24 saat geÃ§erli
- .env ve authorized_key.json ASLA commit edilmez

## Environment Variables
```
DATABASE_PATH=data/pepc.db
JWT_SECRET=xxx
SERPER_API_KEY=xxx
BRAVE_API_KEY=xxx
FIRECRAWL_API_KEY=xxx
ANTHROPIC_API_KEY=xxx
PAYTR_MERCHANT_ID=xxx
```

## .cursorignore ile Korunan Dosyalar
- .env, authorized_key.json (gÃ¼venlik)
- *.db (veritabanlarÄ±)
- *.log (loglar)
- uploads/, thumbnails/ (kullanÄ±cÄ± dosyalarÄ±)
