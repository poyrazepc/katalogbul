<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Detaylı Parça Arama - MakineParça</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#FFC500",
                        "primary-hover": "#e6b200",
                        "background-dark": "#0B0E11",
                        "surface-dark": "#161B22",
                        "surface-hover": "#1F2630",
                        "border-dark": "#30363D",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.125rem",
                        "lg": "0.25rem",
                        "xl": "0.375rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0B0E11; }
        ::-webkit-scrollbar-thumb { background: #30363D; border: 1px solid #0B0E11; }
        ::-webkit-scrollbar-thumb:hover { background: #FFC500; }
        .striped-border {
            background-image: repeating-linear-gradient(45deg, #FFC500, #FFC500 10px, transparent 10px, transparent 20px);
            height: 4px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-background-dark min-h-screen flex flex-col font-display text-gray-300 overflow-x-hidden selection:bg-primary selection:text-black">
    
    <!-- Header -->
    <header class="sticky top-0 z-50 w-full border-b border-border-dark bg-surface-dark shadow-lg">
        <div class="absolute top-0 left-0 right-0 h-[2px] bg-primary"></div>
        <div class="flex items-center justify-between px-6 py-3 max-w-[1440px] mx-auto w-full">
            <div class="flex items-center gap-8">
                <a class="flex items-center gap-3 text-white hover:opacity-80 transition-opacity" href="/">
                    <div class="size-9 text-primary bg-white/5 rounded p-1.5 border border-primary/20">
                        <span class="material-symbols-outlined text-2xl">construction</span>
                    </div>
                    <h2 class="text-xl font-bold leading-tight tracking-tight hidden sm:block text-white">Makine<span class="text-primary">Parça</span></h2>
                </a>
            </div>
            <div class="flex items-center gap-4 sm:gap-8">
                <nav class="hidden lg:flex items-center gap-6">
                    <a class="text-sm font-medium text-gray-400 hover:text-primary transition-colors" href="/">Ana Sayfa</a>
                    <a class="text-sm font-medium text-primary" href="/search.html">Detaylı Arama</a>
                    <a class="text-sm font-medium text-gray-400 hover:text-primary transition-colors" href="/saved-searches.html">Kayıtlı Aramalar</a>
                    <a class="text-sm font-medium text-gray-400 hover:text-primary transition-colors" href="/dashboard.html">Panel</a>
                </nav>
                <div class="flex items-center gap-3">
                    <div id="user-info" class="hidden items-center gap-3">
                        <span class="text-xs font-mono bg-surface-dark border border-border-dark px-2 py-1 rounded">
                            Kredi: <span id="credit-balance" class="text-primary font-bold">0</span>
                        </span>
                    </div>
                    <div id="guest-info" class="flex items-center gap-3">
                        <a href="/login.html" class="text-sm font-medium text-gray-400 hover:text-primary transition-colors">Giriş</a>
                        <a href="/register.html" class="px-4 py-2 bg-primary text-black text-sm font-bold rounded hover:bg-primary-hover transition-colors">Kayıt Ol</a>
                    </div>
                    <div id="auth-buttons" class="hidden items-center gap-3">
                        <a href="/dashboard.html" class="flex items-center justify-center size-9 rounded bg-surface-hover text-white hover:bg-gray-700 transition-colors">
                            <span class="material-symbols-outlined text-[20px]">dashboard</span>
                        </a>
                        <button onclick="logout()" class="flex items-center justify-center size-9 rounded bg-surface-hover text-white hover:bg-gray-700 transition-colors">
                            <span class="material-symbols-outlined text-[20px]">logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 max-w-[1440px] w-full mx-auto">
        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <!-- Page Header -->
            <div class="mb-6">
                <div class="inline-block px-3 py-1 bg-primary/10 border border-primary/30 text-primary text-xs font-bold uppercase mb-3 rounded-sm">
                    Profesyonel Arama
                </div>
                <h1 class="text-3xl md:text-4xl font-black text-white mb-2 tracking-tight uppercase">Detaylı Parça <span class="text-primary">Arama</span></h1>
                <p class="text-gray-400">3 arama motoru ile aynı anda arama yapın, teknik doküman ve yedek parça bulun.</p>
            </div>

            <!-- Search Form Card -->
            <div class="bg-surface-dark border border-border-dark rounded-xl p-6 mb-8">
                <form id="search-form" class="space-y-6">
                    <!-- Main Inputs -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- Marka Seçimi -->
                        <div class="w-full md:w-56">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Marka Seçin</label>
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">factory</span>
                                <select 
                                    id="brand-select"
                                    class="w-full h-14 pl-12 pr-4 bg-background-dark border border-border-dark rounded-lg text-white text-lg focus:ring-2 focus:ring-primary focus:border-primary appearance-none cursor-pointer"
                                >
                                    <option value="">-- Marka Seçin --</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Arama Terimi -->
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Parça no veya model girin (opsiyonel)</label>
                            <div class="relative">
                                <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">search</span>
                                <input 
                                    type="text" 
                                    id="search-query" 
                                    class="w-full h-14 pl-12 pr-4 bg-background-dark border border-border-dark rounded-lg text-white text-lg placeholder:text-gray-600 focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    placeholder="Örn: EC210, 7068-22-3101"
                                >
                            </div>
                        </div>
                        <button 
                            type="submit" 
                            class="h-14 px-10 bg-primary hover:bg-primary-hover text-black font-black rounded-lg transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2 text-lg uppercase tracking-wide whitespace-nowrap"
                        >
                            Aramayı Başlat
                            <span class="material-symbols-outlined">arrow_forward</span>
                        </button>
                    </div>

                    <!-- Filter Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Category - 5 Kategori -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Kategori</label>
                            <select 
                                id="category"
                                class="w-full h-12 px-4 bg-background-dark border border-border-dark rounded text-white text-sm focus:ring-1 focus:ring-primary focus:border-primary appearance-none cursor-pointer"
                            >
                                <option value="parts_catalog">Yedek Parça Kataloğu</option>
                                <option value="service_manual">Servis / Tamir Kılavuzu</option>
                                <option value="electrical_diagram">Elektrik Şeması</option>
                                <option value="hydraulic_diagram">Hidrolik Şeması</option>
                                <option value="troubleshooting">Arıza Teşhis ve Çözüm</option>
                            </select>
                        </div>

                        <!-- Boyut Filtresi -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Min. Dosya Boyutu</label>
                            <select 
                                id="size-filter"
                                class="w-full h-12 px-4 bg-background-dark border border-border-dark rounded text-white text-sm focus:ring-1 focus:ring-primary focus:border-primary appearance-none cursor-pointer"
                            >
                                <option value="all">Tüm Boyutlar</option>
                                <option value="1mb+">1 MB+</option>
                                <option value="5mb+">5 MB+</option>
                                <option value="10mb+">10 MB+</option>
                                <option value="20mb+">20 MB+</option>
                            </select>
                        </div>

                        <!-- Sayfa Başına Sonuç -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Sonuç / Sayfa</label>
                            <select 
                                id="per-page"
                                class="w-full h-12 px-4 bg-background-dark border border-border-dark rounded text-white text-sm focus:ring-1 focus:ring-primary focus:border-primary appearance-none cursor-pointer"
                            >
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>

                        <!-- Languages Dropdown -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Diller</label>
                            <div class="relative">
                                <button 
                                    type="button"
                                    id="language-dropdown-btn"
                                    class="w-full h-12 px-4 bg-background-dark border border-border-dark rounded text-white text-sm text-left flex items-center justify-between focus:ring-1 focus:ring-primary focus:border-primary"
                                >
                                    <span id="selected-lang-text">Tümü (15)</span>
                                    <span class="material-symbols-outlined text-lg">expand_more</span>
                                </button>
                                <div id="language-dropdown" class="hidden absolute z-50 top-full mt-1 w-full bg-surface-dark border border-border-dark rounded shadow-2xl max-h-64 overflow-y-auto">
                                    <div class="p-2 border-b border-border-dark flex gap-3">
                                        <button type="button" onclick="selectAllLanguages()" class="text-xs text-primary hover:underline font-bold">Tümünü Seç</button>
                                        <button type="button" onclick="clearAllLanguages()" class="text-xs text-gray-500 hover:underline">Temizle</button>
                                    </div>
                                    <div id="language-checkboxes" class="p-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Engines Section -->
                    <div class="pt-4 border-t border-border-dark/50">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Arama Motorları</span>
                            <span id="engine-warning" class="text-xs text-gray-500 hidden"></span>
                        </div>
                        <div id="engine-selector" class="flex flex-wrap gap-3"></div>
                    </div>
                </form>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden py-16 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mb-4"></div>
                <p id="loading-text" class="text-gray-400 text-lg">Aranıyor...</p>
                <p id="loading-subtext" class="text-gray-600 text-sm mt-2">3 arama motorunda taranıyor</p>
            </div>

            <!-- Results Container -->
            <div id="results-container" class="hidden">
                <!-- Sticky Header -->
                <div class="sticky top-0 z-40 bg-background-dark pb-4">
                    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6 border-b border-border-dark pb-6">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-white mb-2 tracking-tight" id="results-title">'Arama Sonuçları'</h2>
                            <p class="text-sm text-gray-400" id="results-count">
                                Yaklaşık <span class="font-bold text-primary">0</span> sonuç bulundu
                            </p>
                        </div>
                    </div>

                    <!-- Tab Navigation - 5 Tab: Tümü, Ücretsiz, Premium, Kaynaklar, Kaynak Sonuçları -->
                    <div class="flex border-b border-border-dark overflow-x-auto bg-background-dark">
                    <button id="tab-all" onclick="switchTab('all')" class="px-6 py-3 text-sm font-bold border-b-2 border-primary text-primary transition-colors flex items-center gap-2 whitespace-nowrap">
                        <span class="material-symbols-outlined text-lg">list</span>
                        Tümü
                        <span id="all-count-badge" class="bg-primary/20 text-primary text-xs px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-free" onclick="switchTab('free')" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors flex items-center gap-2 whitespace-nowrap">
                        <span class="material-symbols-outlined text-lg">travel_explore</span>
                        Ücretsiz
                        <span id="free-count-badge" class="bg-surface-hover text-gray-400 text-xs px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-premium" onclick="switchTab('premium')" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors flex items-center gap-2 whitespace-nowrap">
                        <span class="material-symbols-outlined text-lg">workspace_premium</span>
                        Premium
                        <span id="premium-count-badge" class="bg-surface-hover text-gray-400 text-xs px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-sources" onclick="switchTab('sources')" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors flex items-center gap-2 whitespace-nowrap">
                        <span class="material-symbols-outlined text-lg">dns</span>
                        Kaynaklar
                        <span id="sources-count-badge" class="bg-surface-hover text-gray-400 text-xs px-2 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-source-results" onclick="switchTab('source-results')" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors flex items-center gap-2 whitespace-nowrap">
                        <span class="material-symbols-outlined text-lg">folder_open</span>
                        Kaynak Sonuçları
                        <span id="source-results-count-badge" class="bg-surface-hover text-gray-400 text-xs px-2 py-0.5 rounded-full">0</span>
                    </button>
                    </div>
                </div>

                <!-- Scrollable Results Area -->
                <div class="max-h-[calc(100vh-320px)] overflow-y-auto pr-2">
                <!-- All Results Section -->
                <div id="all-section" class="mb-8">
                    <div id="all-results-list" class="flex flex-col gap-4"></div>
                    
                    <!-- All Pagination -->
                    <div id="all-pagination" class="hidden flex justify-center mt-8">
                        <nav class="flex items-center gap-1" id="all-pagination-nav"></nav>
                    </div>
                </div>

                <!-- Free Results Section -->
                <div id="free-section" class="hidden mb-8">
                    <div class="bg-gradient-to-r from-green-900/20 to-emerald-900/20 border border-green-700/30 rounded-lg p-4 mb-6">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-green-500 text-2xl">download</span>
                            <div>
                                <h4 class="text-green-400 font-bold text-sm">Ücretsiz Kaynaklar</h4>
                                <p class="text-green-200/60 text-xs">Doğrudan indirilebilir PDF dosyaları</p>
                            </div>
                        </div>
                    </div>
                    <div id="free-results-list" class="flex flex-col gap-4"></div>
                    
                    <!-- Free Pagination -->
                    <div id="free-pagination" class="hidden flex justify-center mt-8">
                        <nav class="flex items-center gap-1" id="free-pagination-nav"></nav>
                    </div>
                </div>

                <!-- Premium Results Section -->
                <div id="premium-section" class="hidden mb-8">
                    <div class="bg-gradient-to-r from-amber-900/20 to-orange-900/20 border border-amber-700/30 rounded-lg p-4 mb-6">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-amber-500 text-2xl">workspace_premium</span>
                            <div>
                                <h4 class="text-amber-400 font-bold text-sm">Premium Platformlar</h4>
                                <p class="text-amber-200/60 text-xs">Scribd, Issuu, Academia ve diğer premium kaynaklardan bulunan sonuçlar</p>
                            </div>
                        </div>
                    </div>
                    <div id="premium-results-list" class="flex flex-col gap-4"></div>
                    
                    <!-- Premium Pagination -->
                    <div id="premium-pagination" class="hidden flex justify-center mt-8">
                        <nav class="flex items-center gap-1" id="premium-pagination-nav"></nav>
                    </div>
                </div>

                <!-- Sources Section - Benzersiz Kaynaklar -->
                <div id="sources-section" class="hidden mb-8">
                    <div class="bg-gradient-to-r from-cyan-900/20 to-blue-900/20 border border-cyan-700/30 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-cyan-500 text-2xl">dns</span>
                                <div>
                                    <h4 class="text-cyan-400 font-bold text-sm">Bulunan Kaynaklar</h4>
                                    <p class="text-cyan-200/60 text-xs">Arama sonuçlarındaki benzersiz siteler - Daha fazla PDF bulmak için tarayın</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="scanAllSources()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-bold rounded transition-colors flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">radar</span>
                                    Tümünü Tara
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sources Table -->
                    <div class="bg-surface-dark border border-border-dark rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-background-dark border-b border-border-dark">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Kaynak</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Bulunan PDF</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Durum</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">İşlem</th>
                                </tr>
                            </thead>
                            <tbody id="sources-table-body" class="divide-y divide-border-dark">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Source Results Section - Taranan Kaynak Sonuçları -->
                <div id="source-results-section" class="hidden mb-8">
                    <div class="bg-gradient-to-r from-violet-900/20 to-purple-900/20 border border-violet-700/30 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-violet-500 text-2xl">folder_open</span>
                                <div>
                                    <h4 class="text-violet-400 font-bold text-sm">Kaynak Tarama Sonuçları</h4>
                                    <p class="text-violet-200/60 text-xs">Taranan kaynaklardan bulunan tüm PDF dosyaları</p>
                                </div>
                            </div>
                            
                            <!-- Boyut Filtresi -->
                            <div class="flex items-center gap-3">
                                <label class="text-xs font-bold text-gray-500 uppercase">Boyut:</label>
                                <select id="source-size-filter" onchange="filterSourceResults()" class="h-10 px-3 bg-background-dark border border-border-dark rounded text-white text-sm focus:ring-1 focus:ring-primary">
                                    <option value="all">Tümü</option>
                                    <option value="1">1+ MB</option>
                                    <option value="5">5+ MB</option>
                                    <option value="20">20+ MB</option>
                                    <option value="custom">Özel...</option>
                                </select>
                                <input type="number" id="source-size-custom" placeholder="Min MB" class="hidden h-10 w-24 px-3 bg-background-dark border border-border-dark rounded text-white text-sm focus:ring-1 focus:ring-primary" onchange="filterSourceResults()">
                            </div>
                            
                            <!-- Kaynak (Domain) Filtresi -->
                            <div class="flex items-center gap-3">
                                <label class="text-xs font-bold text-gray-500 uppercase">Kaynak:</label>
                                <select id="source-domain-filter" onchange="changeSourceDomainFilter()" class="h-10 px-3 bg-background-dark border border-border-dark rounded text-white text-sm focus:ring-1 focus:ring-primary">
                                    <option value="all">Tümü</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Source Results Progress -->
                    <div id="source-scan-progress" class="hidden mb-6">
                        <div class="bg-surface-dark border border-border-dark rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400" id="source-progress-text">Taranıyor...</span>
                                <span class="text-sm font-bold text-primary" id="source-progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-background-dark rounded-full h-2">
                                <div id="source-progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Source Results List -->
                    <div id="source-results-list" class="flex flex-col gap-4"></div>

                    <!-- Source Results Pagination -->
                    <div id="source-results-pagination" class="hidden flex items-center justify-between gap-3 mt-6 bg-surface-dark border border-border-dark rounded-lg p-3">
                        <div class="text-xs text-gray-400" id="source-results-page-info">-</div>
                        <div class="flex items-center gap-2">
                            <button id="source-results-prev" onclick="changeSourceResultsPage(-1)" class="px-3 py-2 bg-background-dark border border-border-dark text-gray-300 rounded text-sm font-bold hover:bg-surface-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>Önceki</button>
                            <button id="source-results-next" onclick="changeSourceResultsPage(1)" class="px-3 py-2 bg-background-dark border border-border-dark text-gray-300 rounded text-sm font-bold hover:bg-surface-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>Sonraki</button>
                        </div>
                    </div>
                    
                    <!-- Source Results Empty State -->
                    <div id="source-results-empty" class="hidden text-center py-12 text-gray-400">
                        <span class="material-symbols-outlined text-5xl mb-4">search_off</span>
                        <p>Henüz kaynak taraması yapılmadı</p>
                        <p class="text-sm mt-2">Kaynaklar sekmesinden bir site tarayın</p>
                    </div>
                </div>
                </div><!-- End Scrollable Results Area -->
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let lastSearchParams = null;
        let currentTab = 'all';  // 'all', 'free', 'premium', 'sources', 'source-results'
        let allPage = 1;
        let freePage = 1;
        let premiumPage = 1;
        let lastSearchData = null;
        let brandList = [];
        let perPage = 20;
        
        // Source Discovery
        let discoveredSources = [];  // Benzersiz kaynaklar
        let allSourceResults = [];   // Taranan kaynak sonuçları
        let sourceEventSources = {}; // SSE bağlantıları
        let sourceResultsSelectedDomain = 'all'; // 'all' veya domain
        let sourceResultsPage = 1;
        let sourceResultsPerPage = 20;
        
        const LANGUAGES = {
            'en': 'English'
        };
        
        const selectedLangs = new Set(['en']);
        
        const ENGINES = {
            'serper': { name: 'Google', icon: 'search' },
            'brave': { name: 'Brave', icon: 'shield' },
            'yandex': { name: 'Yandex', icon: 'language' }
        };
        
        const TIER_ENGINES = {
            guest: [],
            free: ['serper'],
            pro: ['serper', 'brave', 'yandex'],
            enterprise: ['serper', 'brave', 'yandex']
        };
        
        // Marka listesini yükle
        async function loadBrands() {
            try {
                const response = await fetch(`${API_BASE}/brands`);
                const data = await response.json();
                brandList = data.brands || [];
                
                const select = document.getElementById('brand-select');
                select.innerHTML = '<option value="">-- Marka Seçin --</option>';
                
                brandList.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand.toUpperCase();
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Marka listesi yüklenemedi:', error);
            }
        }
        
        // Check auth
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('guest-info').classList.remove('hidden');
                renderLanguages();
                renderEngines('guest');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/check`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.authenticated) {
                    currentUser = data.user;
                    document.getElementById('guest-info').classList.add('hidden');
                    document.getElementById('user-info').classList.remove('hidden');
                    document.getElementById('user-info').classList.add('flex');
                    document.getElementById('auth-buttons').classList.remove('hidden');
                    document.getElementById('auth-buttons').classList.add('flex');
                    document.getElementById('credit-balance').textContent = data.user.credit_balance;
                    renderLanguages();
                    // Admin role'ü varsa enterprise tier kullan (tüm motorlar)
                    const effectiveTier = data.user.role === 'admin' ? 'enterprise' : data.user.subscription_tier;
                    renderEngines(effectiveTier);
                } else {
                    localStorage.removeItem('token');
                    renderLanguages();
                    renderEngines('guest');
                }
            } catch (error) {
                console.error('Auth check error:', error);
                renderLanguages();
                renderEngines('guest');
            }
        }
        
        // Render languages
        function renderLanguages() {
            const container = document.getElementById('language-checkboxes');
            container.innerHTML = '';
            
            Object.entries(LANGUAGES).forEach(([code, name]) => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-3 px-2 py-1.5 hover:bg-surface-hover rounded cursor-pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = code;
                checkbox.checked = selectedLangs.has(code);
                checkbox.className = 'rounded border-gray-600 bg-background-dark text-primary focus:ring-primary/50';
                checkbox.onchange = () => {
                    checkbox.checked ? selectedLangs.add(code) : selectedLangs.delete(code);
                    updateLanguageText();
                };
                
                const span = document.createElement('span');
                span.textContent = name;
                span.className = 'text-sm text-gray-400';
                
                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);
            });
            updateLanguageText();
        }
        
        function updateLanguageText() {
            const text = selectedLangs.size === Object.keys(LANGUAGES).length 
                ? `Tümü (${selectedLangs.size})`
                : `${selectedLangs.size} dil seçili`;
            document.getElementById('selected-lang-text').textContent = text;
        }
        
        function selectAllLanguages() {
            Object.keys(LANGUAGES).forEach(code => selectedLangs.add(code));
            renderLanguages();
        }
        
        function clearAllLanguages() {
            selectedLangs.clear();
            renderLanguages();
        }
        
        // Language dropdown toggle
        document.getElementById('language-dropdown-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('language-dropdown').classList.toggle('hidden');
        });
        
        document.addEventListener('click', () => {
            document.getElementById('language-dropdown').classList.add('hidden');
        });
        
        document.getElementById('language-dropdown').addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Render engines
        function renderEngines(tier) {
            const container = document.getElementById('engine-selector');
            const warning = document.getElementById('engine-warning');
            container.innerHTML = '';
            
            const allowed = TIER_ENGINES[tier] || [];
            
            if (allowed.length === 0) {
                warning.textContent = 'Motor seçimi Pro+ üyelik gerektirir';
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            Object.entries(ENGINES).forEach(([key, engine]) => {
                const isAllowed = allowed.includes(key);
                
                const label = document.createElement('label');
                label.className = `inline-flex items-center gap-2 px-4 py-2 rounded border text-sm font-medium transition-all cursor-pointer ${
                    isAllowed 
                        ? 'border-border-dark hover:border-primary hover:bg-primary/5' 
                        : 'border-border-dark/50 opacity-40 cursor-not-allowed'
                }`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'engines';
                checkbox.value = key;
                checkbox.checked = isAllowed;
                checkbox.disabled = !isAllowed;
                checkbox.className = 'rounded border-gray-600 bg-background-dark text-primary focus:ring-primary/50';
                
                const icon = document.createElement('span');
                icon.className = 'material-symbols-outlined text-lg';
                icon.textContent = engine.icon;
                
                const span = document.createElement('span');
                span.textContent = engine.name;
                span.className = 'text-white';
                
                label.appendChild(checkbox);
                label.appendChild(icon);
                label.appendChild(span);
                container.appendChild(label);
            });
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('token');
            window.location.reload();
        }
        
        // Search form submit
        document.getElementById('search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const brandSelect = document.getElementById('brand-select').value;
            const searchQuery = document.getElementById('search-query').value.trim();
            const category = document.getElementById('category').value;
            const sizeFilter = document.getElementById('size-filter').value;
            perPage = parseInt(document.getElementById('per-page').value) || 20;
            const selectedLangsList = Array.from(selectedLangs);
            const selectedEngines = Array.from(document.querySelectorAll('input[name="engines"]:checked')).map(cb => cb.value);
            
            // En az marka veya arama terimi olmalı
            if (!brandSelect && !searchQuery) {
                alert('Lütfen bir marka seçin veya arama terimi girin');
                return;
            }
            
            if (selectedLangsList.length === 0) {
                alert('En az bir dil seçin');
                return;
            }
            
            // Arama terimini oluştur: marka + model/sorgu
            const brand = brandSelect || null;
            const model = brandSelect && searchQuery ? searchQuery : null;
            const queryText = !brandSelect && searchQuery ? searchQuery : null;
            
            // Arama parametrelerini kaydet
            lastSearchParams = {
                brand,
                model,
                query_text: queryText,
                category,
                size_filter: sizeFilter,
                languages: selectedLangsList,
                engines: selectedEngines,
                per_page: perPage
            };
            
            // Sayfa sıfırla
            allPage = 1;
            freePage = 1;
            premiumPage = 1;
            currentTab = 'all';
            
            await performSearch();
        });
        
        // Arama fonksiyonu
        async function performSearch(page = 1) {
            if (!lastSearchParams) return;
            
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results-container').classList.add('hidden');
            
            try {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                const response = await fetch(`${API_BASE}/multi-search`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        ...lastSearchParams,
                        page: page,
                        per_page: perPage
                    })
                });
                
                // Backend bazen non-JSON hata döndürebilir (500 Internal Server Error gibi)
                const contentType = (response.headers.get('content-type') || '').toLowerCase();
                let data = null;
                let rawText = '';
                
                if (contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    rawText = await response.text();
                }
                
                if (!response.ok) {
                    const detail = data?.detail;
                    const message =
                        (typeof detail === 'string' ? detail : detail?.message) ||
                        data?.message ||
                        rawText ||
                        'Arama başarısız';
                    throw new Error(message);
                }
                
                lastSearchData = data;
                const queryDisplay = lastSearchParams.brand || lastSearchParams.query_text || 'Arama';
                displayResults(queryDisplay, data);
                if (currentUser && data?.credits_used) {
                    currentUser.credit_balance -= data.credits_used;
                    document.getElementById('credit-balance').textContent = currentUser.credit_balance;
                }
            } catch (error) {
                console.error('Search error:', error);
                alert(error?.message || 'Bağlantı hatası');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        // Display results
        function displayResults(query, data) {
            console.log('API Response:', data);  // Debug log
            
            const allContainer = document.getElementById('all-results-list');
            const freeContainer = document.getElementById('free-results-list');
            const premiumContainer = document.getElementById('premium-results-list');
            allContainer.innerHTML = '';
            freeContainer.innerHTML = '';
            premiumContainer.innerHTML = '';
            
            // API response yapısı
            const allData = data.all || { results: [], total: 0, page: 1, total_pages: 1 };
            const freeData = data.free || { results: [], total: 0, page: 1, total_pages: 1 };
            const premiumData = data.premium || { results: [], total: 0, page: 1, total_pages: 1 };
            const counts = data.counts || { total: 0, free: 0, premium: 0 };
            
            console.log('All:', allData.total, 'Free:', freeData.total, 'Premium:', premiumData.total);
            
            // Query'yi oluştur
            let displayQuery = query;
            if (lastSearchParams && lastSearchParams.model) {
                displayQuery = `${lastSearchParams.brand} ${lastSearchParams.model}`;
            }
            
            document.getElementById('results-title').textContent = `'${displayQuery.toUpperCase()}'`;
            document.getElementById('results-count').innerHTML = `Toplam <span class="font-bold text-primary">${counts.total}</span> sonuç bulundu`;
            
            // Badge'leri güncelle
            document.getElementById('all-count-badge').textContent = counts.total;
            document.getElementById('free-count-badge').textContent = counts.free;
            document.getElementById('premium-count-badge').textContent = counts.premium;
            
            // Tab'ı sıfırla
            switchTab(currentTab);
            
            if (counts.total === 0) {
                allContainer.innerHTML = '<div class="text-center py-12 text-gray-400"><span class="material-symbols-outlined text-5xl mb-4">search_off</span><p>Sonuç bulunamadı</p></div>';
                freeContainer.innerHTML = '<div class="text-center py-12 text-gray-400"><span class="material-symbols-outlined text-5xl mb-4">search_off</span><p>Sonuç bulunamadı</p></div>';
                premiumContainer.innerHTML = '<div class="text-center py-12 text-gray-400"><span class="material-symbols-outlined text-5xl mb-4">search_off</span><p>Sonuç bulunamadı</p></div>';
                document.getElementById('results-container').classList.remove('hidden');
                return;
            }
            
            // All sonuçları render et
            if (allData.results.length > 0) {
                allData.results.forEach(result => renderResultCard(result, allContainer, result.is_premium));
                renderPagination('all', allData.page, allData.total_pages, allData.total);
            } else {
                allContainer.innerHTML = '<div class="text-center py-12 text-gray-400"><span class="material-symbols-outlined text-5xl mb-4">folder_off</span><p>Bu sayfada sonuç yok</p></div>';
                document.getElementById('all-pagination').classList.add('hidden');
            }
            
            // Free sonuçları render et
            if (freeData.results.length > 0) {
                freeData.results.forEach(result => renderResultCard(result, freeContainer, false));
                renderPagination('free', freeData.page, freeData.total_pages, freeData.total);
            } else {
                freeContainer.innerHTML = '<div class="text-center py-12 text-gray-400"><span class="material-symbols-outlined text-5xl mb-4">folder_off</span><p>Ücretsiz kaynaklarda sonuç bulunamadı</p></div>';
                document.getElementById('free-pagination').classList.add('hidden');
            }
            
            // Premium sonuçları render et
            if (premiumData.results.length > 0) {
                premiumData.results.forEach(result => renderResultCard(result, premiumContainer, true));
                renderPagination('premium', premiumData.page, premiumData.total_pages, premiumData.total);
            } else {
                premiumContainer.innerHTML = '<div class="text-center py-12 text-gray-400"><span class="material-symbols-outlined text-5xl mb-4">folder_off</span><p>Premium kaynaklarda sonuç bulunamadı</p></div>';
                document.getElementById('premium-pagination').classList.add('hidden');
            }
            
            document.getElementById('results-container').classList.remove('hidden');
            
            // Kaynakları çıkar (tüm sonuçlardan)
            const allResults = [...(allData.results || []), ...(freeData.results || []), ...(premiumData.results || [])];
            if (allResults.length > 0) {
                extractSources(allResults);
            }
        }
        
        // Tek sonuç kartı render et
        function renderResultCard(result, container, isPremium = false) {
            // Admin veya pro/enterprise tier indirme yapabilir
            const canDownload = currentUser && (currentUser.role === 'admin' || currentUser.subscription_tier === 'pro' || currentUser.subscription_tier === 'enterprise');
            
            const card = document.createElement('article');
            card.className = `flex flex-col p-5 rounded border ${isPremium ? 'border-amber-700/30 bg-amber-950/20' : 'border-border-dark bg-surface-dark'} hover:border-primary/60 transition-colors group relative shadow-sm`;
            
            const platformBadge = isPremium && result.platform 
                ? `<span class="bg-amber-900/40 text-amber-200 border border-amber-800 text-[10px] font-bold px-2 py-0.5 rounded-sm uppercase tracking-wider">${result.platform || 'Premium'}</span>`
                : '';
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="bg-red-900/40 text-red-200 border border-red-800 text-[10px] font-bold px-2 py-0.5 rounded-sm uppercase tracking-wider">PDF</span>
                        ${platformBadge}
                        <span class="text-xs text-gray-400 flex items-center gap-1 font-mono">
                            <span class="material-symbols-outlined text-[14px]">public</span> ${result.engine || 'Google'} • ${(result.language || 'en').toUpperCase()}
                        </span>
                    </div>
                    <button class="text-gray-600 hover:text-primary transition-colors" title="Kaydet">
                        <span class="material-symbols-outlined text-[24px]">bookmark</span>
                    </button>
                </div>
                <a class="text-xl font-bold ${isPremium ? 'text-amber-400 hover:text-amber-300' : 'text-primary hover:text-primary-hover'} hover:underline mb-2" href="${result.url}" target="_blank">
                    ${result.title || 'PDF Dosyası'}
                </a>
                <p class="text-xs text-green-500/80 mb-3 truncate max-w-full font-mono">
                    ${result.url}
                </p>
                <p class="text-sm text-gray-400 leading-relaxed mb-4">
                    ${result.snippet || 'Açıklama mevcut değil...'}
                </p>
                <div class="flex items-center justify-between mt-auto border-t border-white/5 pt-3">
                    <div class="flex items-center gap-4 text-xs text-gray-500">
                        ${result.file_size ? `<span class="flex items-center gap-1"><span class="material-symbols-outlined text-[16px]">download</span> ${result.file_size}</span>` : ''}
                        ${result.is_cached ? '<span class="flex items-center gap-1 text-green-500"><span class="material-symbols-outlined text-[16px]">cached</span> Cache</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="scanSource('${result.url}')" class="px-3 py-2 bg-surface-hover text-gray-300 rounded text-sm font-medium hover:bg-primary/20 hover:text-primary transition-colors flex items-center gap-1" title="Bu kaynakta daha fazla PDF ara">
                            <span class="material-symbols-outlined text-lg">travel_explore</span> Kaynak Tara
                        </button>
                        ${canDownload 
                            ? `<a href="${result.url}" target="_blank" class="px-4 py-2 bg-primary text-black rounded text-sm font-bold hover:bg-primary-hover transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">download</span> İndir
                              </a>`
                            : `<button onclick="showUpgradeModal()" class="px-4 py-2 bg-surface-hover text-gray-400 rounded text-sm font-bold flex items-center gap-2 cursor-not-allowed">
                                <span class="material-symbols-outlined text-lg">lock</span> Kilitli
                              </button>`
                        }
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        }
        
        // Tab değiştirme - 5 tab sistemi
        function switchTab(tab) {
            currentTab = tab;
            
            const tabs = ['all', 'free', 'premium', 'sources', 'source-results'];
            const inactiveTabClass = 'px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors flex items-center gap-2 whitespace-nowrap';
            const inactiveBadgeClass = 'bg-surface-hover text-gray-400 text-xs px-2 py-0.5 rounded-full';
            
            // Tüm tab'ları sıfırla
            tabs.forEach(t => {
                const tabEl = document.getElementById(`tab-${t}`);
                const sectionEl = document.getElementById(`${t}-section`);
                const badgeEl = document.getElementById(`${t}-count-badge`);
                
                if (tabEl) tabEl.className = inactiveTabClass;
                if (sectionEl) sectionEl.classList.add('hidden');
                if (badgeEl) badgeEl.className = inactiveBadgeClass;
            });
            
            // Aktif tab'ı ayarla
            const activeTab = document.getElementById(`tab-${tab}`);
            const activeSection = document.getElementById(`${tab}-section`);
            const activeBadge = document.getElementById(`${tab}-count-badge`);
            
            const tabColors = {
                'all': { border: 'border-primary', text: 'text-primary', badge: 'bg-primary/20 text-primary' },
                'free': { border: 'border-green-500', text: 'text-green-400', badge: 'bg-green-500/20 text-green-400' },
                'premium': { border: 'border-amber-500', text: 'text-amber-400', badge: 'bg-amber-500/20 text-amber-400' },
                'sources': { border: 'border-cyan-500', text: 'text-cyan-400', badge: 'bg-cyan-500/20 text-cyan-400' },
                'source-results': { border: 'border-violet-500', text: 'text-violet-400', badge: 'bg-violet-500/20 text-violet-400' }
            };
            
            const color = tabColors[tab];
            if (activeTab) activeTab.className = `px-6 py-3 text-sm font-bold border-b-2 ${color.border} ${color.text} transition-colors flex items-center gap-2 whitespace-nowrap`;
            if (activeSection) activeSection.classList.remove('hidden');
            if (activeBadge) activeBadge.className = `${color.badge} text-xs px-2 py-0.5 rounded-full`;
            
            // Source results empty state kontrolü
            if (tab === 'source-results' && allSourceResults.length === 0) {
                document.getElementById('source-results-empty').classList.remove('hidden');
            } else if (tab === 'source-results') {
                document.getElementById('source-results-empty').classList.add('hidden');
            }
        }
        
        // Sayfalama render
        function renderPagination(type, currentPage, totalPages, totalItems) {
            const nav = document.getElementById(`${type}-pagination-nav`);
            const paginationDiv = document.getElementById(`${type}-pagination`);
            
            if (totalPages <= 1) {
                paginationDiv.classList.add('hidden');
                return;
            }
            
            paginationDiv.classList.remove('hidden');
            nav.innerHTML = '';
            
            // Önceki buton
            const prevBtn = document.createElement('button');
            prevBtn.className = `p-2 rounded ${currentPage === 1 ? 'text-gray-600 cursor-not-allowed' : 'hover:bg-surface-hover text-gray-500 hover:text-white'}`;
            prevBtn.innerHTML = '<span class="material-symbols-outlined">chevron_left</span>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => goToPage(type, currentPage - 1);
            nav.appendChild(prevBtn);
            
            // Sayfa numaraları
            const pages = getPageNumbers(currentPage, totalPages);
            pages.forEach(page => {
                if (page === '...') {
                    const dots = document.createElement('span');
                    dots.className = 'px-2 text-gray-600';
                    dots.textContent = '...';
                    nav.appendChild(dots);
                } else {
                    const btn = document.createElement('button');
                    btn.className = page === currentPage 
                        ? `px-4 py-2 rounded ${type === 'premium' ? 'bg-amber-500 text-black' : 'bg-primary text-black'} font-bold`
                        : 'px-4 py-2 rounded hover:bg-surface-hover text-gray-400 hover:text-white font-medium transition-colors';
                    btn.textContent = page;
                    btn.onclick = () => goToPage(type, page);
                    nav.appendChild(btn);
                }
            });
            
            // Sonraki buton
            const nextBtn = document.createElement('button');
            nextBtn.className = `p-2 rounded ${currentPage === totalPages ? 'text-gray-600 cursor-not-allowed' : 'hover:bg-surface-hover text-gray-500 hover:text-white'}`;
            nextBtn.innerHTML = '<span class="material-symbols-outlined">chevron_right</span>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => goToPage(type, currentPage + 1);
            nav.appendChild(nextBtn);
            
            // Sayfa bilgisi
            const info = document.createElement('span');
            info.className = 'ml-4 text-xs text-gray-500';
            info.textContent = `${totalItems} sonuçtan ${(currentPage - 1) * perPage + 1}-${Math.min(currentPage * perPage, totalItems)} arası`;
            nav.appendChild(info);
        }
        
        // Sayfa numaralarını hesapla
        function getPageNumbers(current, total) {
            if (total <= 7) {
                return Array.from({ length: total }, (_, i) => i + 1);
            }
            
            const pages = [];
            pages.push(1);
            
            if (current > 3) {
                pages.push('...');
            }
            
            for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
                pages.push(i);
            }
            
            if (current < total - 2) {
                pages.push('...');
            }
            
            pages.push(total);
            
            return pages;
        }
        
        // Sayfaya git
        async function goToPage(type, page) {
            if (type === 'all') {
                allPage = page;
            } else if (type === 'free') {
                freePage = page;
            } else {
                premiumPage = page;
            }
            
            // Yeni arama yap
            await performSearch(page);
            
            // Scroll to top of results
            document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Show upgrade modal
        function showUpgradeModal() {
            if (confirm('İndirmek için Pro veya Enterprise pakete geçiş yapmalısınız. Fiyatlandırma sayfasına gitmek ister misiniz?')) {
                window.location.href = '/#pricing';
            }
        }
        
        // ================================================================
        // KAYNAK KEŞİF FONKSİYONLARI (Source Discovery)
        // ================================================================
        
        // Arama sonuçlarından kaynakları çıkar
        async function extractSources(results) {
            try {
                const response = await fetch(`${API_BASE}/sources/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(results)
                });
                
                const data = await response.json();
                discoveredSources = data.sources || [];
                
                // Tab badge güncelle
                document.getElementById('sources-count-badge').textContent = discoveredSources.length;
                
                // Tablo render et
                renderSourcesTable();
                
            } catch (error) {
                console.error('Source extraction error:', error);
            }
        }
        
        // Kaynaklar tablosunu render et
        function renderSourcesTable() {
            const tbody = document.getElementById('sources-table-body');
            
            if (!discoveredSources || discoveredSources.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                            Kaynak bulunamadı
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = discoveredSources.map((source, index) => {
                const statusBadge = getSourceStatusBadge(source.status, source.progress);
                const actionButton = getSourceActionButton(source, index);
                
                return `
                    <tr class="hover:bg-surface-hover transition-colors" id="source-row-${index}">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-cyan-500">language</span>
                                <div>
                                    <div class="font-bold text-white">${source.domain}</div>
                                    <div class="text-xs text-gray-500">${source.paths.slice(0, 2).join(', ')}${source.paths.length > 2 ? '...' : ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="bg-surface-hover text-white text-sm px-2 py-1 rounded">${source.pdf_count}</span>
                        </td>
                        <td class="px-4 py-3 text-center" id="source-status-${index}">
                            ${statusBadge}
                        </td>
                        <td class="px-4 py-3 text-center" id="source-action-${index}">
                            ${actionButton}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Kaynak durum badge'i
        function getSourceStatusBadge(status, progress = 0) {
            const badges = {
                'pending': '<span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">⏳ Bekliyor</span>',
                'scanning': `<span class="bg-blue-900 text-blue-300 text-xs px-2 py-1 rounded">🔄 %${progress}</span>`,
                'enriching': `<span class="bg-purple-900 text-purple-300 text-xs px-2 py-1 rounded">📊 %${progress}</span>`,
                'completed': '<span class="bg-green-900 text-green-300 text-xs px-2 py-1 rounded">✅ Tamamlandı</span>',
                'error': '<span class="bg-red-900 text-red-300 text-xs px-2 py-1 rounded">❌ Hata</span>',
                'cached': '<span class="bg-yellow-900 text-yellow-300 text-xs px-2 py-1 rounded">📦 Önbellek</span>'
            };
            return badges[status] || badges['pending'];
        }
        
        // Kaynak işlem butonu
        function getSourceActionButton(source, index) {
            if (source.status === 'scanning' || source.status === 'enriching') {
                return `<button disabled class="px-3 py-1.5 bg-gray-700 text-gray-400 text-sm rounded cursor-not-allowed">Taranıyor...</button>`;
            } else if (source.status === 'completed') {
                return `<button onclick="viewSourceResults('${source.domain}')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 text-white text-sm font-bold rounded transition-colors">👁️ Göster</button>`;
            } else {
                return `<button onclick="scanSingleSource(${index})" class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-bold rounded transition-colors flex items-center gap-1 mx-auto"><span class="material-symbols-outlined text-sm">radar</span> Tara</button>`;
            }
        }
        
        // Sonuç kartından kaynak tara
        function scanSource(url) {
            try {
                const parsed = new URL(url);
                const domain = parsed.hostname.replace('www.', '');
                const path = parsed.pathname.split('/').slice(0, -1).join('/') || '/';
                
                // discoveredSources'da var mı bak
                let index = discoveredSources.findIndex(s => s.domain === domain);
                
                if (index === -1) {
                    // Yoksa ekle
                    discoveredSources.push({
                        domain: domain,
                        paths: [path],
                        pdf_count: 1,
                        status: 'pending',
                        progress: 0
                    });
                    index = discoveredSources.length - 1;
                    document.getElementById('sources-count-badge').textContent = discoveredSources.length;
                    renderSourcesTable();
                }
                
                // Kaynaklar tab'ına geç ve tara
                switchTab('sources');
                scanSingleSource(index);
                
            } catch (e) {
                console.error('Invalid URL:', url);
                alert('Geçersiz URL');
            }
        }
        
        // Tek kaynak tara (SSE ile)
        async function scanSingleSource(index) {
            const source = discoveredSources[index];
            if (!source) return;
            
            source.status = 'scanning';
            source.progress = 0;
            updateSourceRow(index);
            
            const paths = source.paths.join(',');
            const url = `${API_BASE}/sources/${encodeURIComponent(source.domain)}/scan?paths=${encodeURIComponent(paths)}`;
            
            const eventSource = new EventSource(url);
            sourceEventSources[source.domain] = eventSource;
            
            eventSource.addEventListener('progress', (e) => {
                const data = JSON.parse(e.data);
                source.status = data.status;
                source.progress = data.progress;
                updateSourceRow(index);
                
                // Progress bar güncelle
                updateSourceProgress(data.progress, data.message);
            });
            
            eventSource.addEventListener('pdfs', (e) => {
                const data = JSON.parse(e.data);
                // Yeni PDF'leri ekle
                data.pdfs.forEach(pdf => {
                    if (!allSourceResults.find(p => p.url === pdf.url)) {
                        allSourceResults.push(pdf);
                    }
                });
                updateSourceResultsBadge();
            });
            
            eventSource.addEventListener('pdfs_updated', (e) => {
                const data = JSON.parse(e.data);
                // Boyut bilgisi güncelle
                data.pdfs.forEach(updatedPdf => {
                    const existing = allSourceResults.find(p => p.url === updatedPdf.url);
                    if (existing) {
                        Object.assign(existing, updatedPdf);
                    }
                });
                renderSourceResultsList();
            });
            
            eventSource.addEventListener('complete', (e) => {
                const data = JSON.parse(e.data);
                source.status = 'completed';
                source.progress = 100;
                updateSourceRow(index);
                hideSourceProgress();
                eventSource.close();
                delete sourceEventSources[source.domain];
                
                // Kaynak sonuçları tab'ına geç
                if (allSourceResults.length > 0) {
                    renderSourceResultsList();
                }
            });
            
            eventSource.addEventListener('error', (e) => {
                let errorMsg = 'Bağlantı hatası';
                try {
                    const data = JSON.parse(e.data);
                    errorMsg = data.message || errorMsg;
                } catch {}
                
                source.status = 'error';
                source.error_message = errorMsg;
                updateSourceRow(index);
                hideSourceProgress();
                eventSource.close();
                delete sourceEventSources[source.domain];
            });
            
            eventSource.onerror = () => {
                source.status = 'error';
                updateSourceRow(index);
                hideSourceProgress();
                eventSource.close();
                delete sourceEventSources[source.domain];
            };
            
            // Progress bar göster
            showSourceProgress();
        }
        
        // Tüm kaynakları tara
        async function scanAllSources() {
            for (let i = 0; i < discoveredSources.length; i++) {
                const source = discoveredSources[i];
                if (source.status === 'pending' || source.status === 'error') {
                    await scanSingleSource(i);
                    // Bir sonraki taramadan önce bekle
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
        
        // Kaynak satırını güncelle
        function updateSourceRow(index) {
            const source = discoveredSources[index];
            const statusCell = document.getElementById(`source-status-${index}`);
            const actionCell = document.getElementById(`source-action-${index}`);
            
            if (statusCell) statusCell.innerHTML = getSourceStatusBadge(source.status, source.progress);
            if (actionCell) actionCell.innerHTML = getSourceActionButton(source, index);
        }
        
        // Source results badge güncelle
        function updateSourceResultsBadge() {
            document.getElementById('source-results-count-badge').textContent = allSourceResults.length;
        }
        
        // Progress bar göster
        function showSourceProgress() {
            document.getElementById('source-scan-progress').classList.remove('hidden');
        }
        
        // Progress bar gizle
        function hideSourceProgress() {
            document.getElementById('source-scan-progress').classList.add('hidden');
        }
        
        // Progress güncelle
        function updateSourceProgress(percent, message) {
            document.getElementById('source-progress-bar').style.width = percent + '%';
            document.getElementById('source-progress-percent').textContent = percent + '%';
            document.getElementById('source-progress-text').textContent = message || 'Taranıyor...';
        }
        
        // Kaynak sonuçlarını listele
        function renderSourceResultsList() {
            const container = document.getElementById('source-results-list');
            const emptyState = document.getElementById('source-results-empty');
            const pagination = document.getElementById('source-results-pagination');
            
            // Filtre uygula
            const filtered = getFilteredSourceResults();
            
            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                if (pagination) pagination.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            if (pagination) pagination.classList.remove('hidden');
            
            // Domain filtresi seçeneklerini güncelle (sonuçlar geldikçe)
            updateSourceDomainFilterOptions();
            
            // Boyuta göre sırala (büyük önce)
            filtered.sort((a, b) => (b.size_bytes || 0) - (a.size_bytes || 0));
            
            // Sayfalama
            const total = filtered.length;
            const totalPages = Math.max(1, Math.ceil(total / sourceResultsPerPage));
            sourceResultsPage = Math.min(sourceResultsPage, totalPages);
            sourceResultsPage = Math.max(sourceResultsPage, 1);
            
            const start = (sourceResultsPage - 1) * sourceResultsPerPage;
            const pageItems = filtered.slice(start, start + sourceResultsPerPage);
            
            container.innerHTML = pageItems.map(pdf => {
                const sizeClass = getSizeClass(pdf.size_mb);
                return `
                    <div class="flex flex-col p-5 rounded border border-violet-700/30 bg-violet-950/20 hover:border-violet-500/60 transition-colors group">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <a href="${pdf.url}" target="_blank" class="text-lg font-bold text-violet-400 hover:text-violet-300 hover:underline block truncate">
                                    ${pdf.title || 'PDF Dosyası'}
                                </a>
                                <p class="text-xs text-gray-500 mt-1 truncate">${pdf.url}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="${sizeClass} text-sm px-2 py-1 rounded font-bold">
                                    ${pdf.size_formatted || '?'}
                                </span>
                                <a href="${pdf.url}" target="_blank" class="p-2 bg-violet-600 hover:bg-violet-500 text-white rounded transition-colors">
                                    <span class="material-symbols-outlined text-lg">download</span>
                                </a>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">dns</span>
                                ${pdf.source_domain}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            renderSourceResultsPagination(total, totalPages);
        }
        
        // Boyut sınıfı
        function getSizeClass(sizeMb) {
            if (!sizeMb) return 'bg-gray-700 text-gray-300';
            if (sizeMb >= 20) return 'bg-green-900 text-green-300';
            if (sizeMb >= 5) return 'bg-blue-900 text-blue-300';
            if (sizeMb >= 1) return 'bg-yellow-900 text-yellow-300';
            return 'bg-gray-700 text-gray-300';
        }
        
        // Filtrelenmiş sonuçlar
        function getFilteredSourceResults() {
            const domainFilterEl = document.getElementById('source-domain-filter');
            if (domainFilterEl) {
                sourceResultsSelectedDomain = domainFilterEl.value || 'all';
            }
            
            const filterValue = document.getElementById('source-size-filter').value;
            let minMb = 0;
            
            if (filterValue === 'custom') {
                minMb = parseFloat(document.getElementById('source-size-custom').value) || 0;
            } else if (filterValue !== 'all') {
                minMb = parseFloat(filterValue) || 0;
            }
            
            let results = allSourceResults;
            if (sourceResultsSelectedDomain !== 'all') {
                results = results.filter(pdf => pdf.source_domain === sourceResultsSelectedDomain);
            }
            
            if (minMb === 0) return results;
            
            return results.filter(pdf => (pdf.size_mb || 0) >= minMb);
        }
        
        // Boyut filtresi değişti
        function filterSourceResults() {
            const filterValue = document.getElementById('source-size-filter').value;
            const customInput = document.getElementById('source-size-custom');
            
            if (filterValue === 'custom') {
                customInput.classList.remove('hidden');
            } else {
                customInput.classList.add('hidden');
            }
            
            sourceResultsPage = 1;
            renderSourceResultsList();
            updateSourceResultsBadge();
        }
        
        // Domain filtresi değişti
        function changeSourceDomainFilter() {
            sourceResultsPage = 1;
            renderSourceResultsList();
        }
        
        // Domain filtresi seçeneklerini güncelle
        function updateSourceDomainFilterOptions() {
            const select = document.getElementById('source-domain-filter');
            if (!select) return;
            
            const currentValue = select.value || sourceResultsSelectedDomain || 'all';
            const domainSet = new Set();
            
            // Önce taranan sonuçlardan domain'leri al (gerçek)
            allSourceResults.forEach(pdf => {
                if (pdf && pdf.source_domain) domainSet.add(pdf.source_domain);
            });
            
            // Ek olarak discoveredSources'dan da (henüz sonuç gelmemiş olabilir)
            discoveredSources.forEach(s => {
                if (s && s.domain) domainSet.add(s.domain);
            });
            
            const domains = Array.from(domainSet).sort((a, b) => a.localeCompare(b));
            
            select.innerHTML = [
                `<option value="all">Tümü</option>`,
                ...domains.map(d => `<option value="${d}">${d}</option>`)
            ].join('');
            
            // Mevcut seçim korunmaya çalışılsın
            select.value = domains.includes(currentValue) ? currentValue : 'all';
            sourceResultsSelectedDomain = select.value;
        }
        
        // Sayfa değiştir (delta = -1/+1)
        function changeSourceResultsPage(delta) {
            const filtered = getFilteredSourceResults();
            const totalPages = Math.max(1, Math.ceil(filtered.length / sourceResultsPerPage));
            sourceResultsPage = Math.max(1, Math.min(totalPages, sourceResultsPage + delta));
            renderSourceResultsList();
        }
        
        // Sayfalama UI güncelle
        function renderSourceResultsPagination(total, totalPages) {
            const pagination = document.getElementById('source-results-pagination');
            const info = document.getElementById('source-results-page-info');
            const prevBtn = document.getElementById('source-results-prev');
            const nextBtn = document.getElementById('source-results-next');
            
            if (!pagination || !info || !prevBtn || !nextBtn) return;
            
            if (total <= sourceResultsPerPage) {
                pagination.classList.add('hidden');
                return;
            }
            
            pagination.classList.remove('hidden');
            
            const start = (sourceResultsPage - 1) * sourceResultsPerPage + 1;
            const end = Math.min(total, sourceResultsPage * sourceResultsPerPage);
            const domainText = sourceResultsSelectedDomain === 'all' ? 'Tümü' : sourceResultsSelectedDomain;
            info.textContent = `${domainText} • ${start}-${end} / ${total} • Sayfa ${sourceResultsPage}/${totalPages}`;
            
            prevBtn.disabled = sourceResultsPage <= 1;
            nextBtn.disabled = sourceResultsPage >= totalPages;
        }
        
        // Belirli kaynağın sonuçlarını göster
        function viewSourceResults(domain) {
            // Domain seç ve tab'a geç
            updateSourceDomainFilterOptions();
            const select = document.getElementById('source-domain-filter');
            if (select) {
                select.value = domain;
                sourceResultsSelectedDomain = domain;
            } else {
                sourceResultsSelectedDomain = domain;
            }
            
            sourceResultsPage = 1;
            switchTab('source-results');
            renderSourceResultsList();
        }
        
        // Initialize
        checkAuth();
        loadBrands();
    </script>
</body>
</html>
